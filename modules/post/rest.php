<?php namespace NextFeed\Modules\Post;defined('ABSPATH')||exit;Class Rest{private static $instance;public function __init(){add_action('rest_api_init',function(){register_rest_route('nextfeed/','/v(?P<version>\d+)/(?P<route>\w+)',array('methods'=>'GET','callback'=>[$this,'_get_template_info'],));register_rest_route('nextfeed/','/v(?P<version>\d+)/(?P<route>\w+)',array('methods'=>'POST','callback'=>[$this,'_get_template_info'],));});}public function _get_template_info(\WP_REST_Request $request){$version=isset($request['version'])?$request['version']:'1';$route=isset($request['route'])?$request['route']:'';if(empty($route)){return 'Not found..';}$result=[];$id=isset($request['idtemp'])?$request['idtemp']:'';$getTemplate=Action::instance()->_temp_type();switch($route){case 'categories':$result=isset($getTemplate[$id]['categories'])?$getTemplate[$id]['categories']:[];break;case 'type':$result=isset($getTemplate[$id])?$getTemplate[$id]:[];break;case 'save':$forms=isset($request['nextfeed'])?$request['nextfeed']:[];$forms=apply_filters('_nextfeed_postforms_submit_set_data',$forms);$result=$this->_save_forms($id,$forms);break;case 'getforms':$result=$this->_getforms($id);break;}return json_encode($result,JSON_UNESCAPED_UNICODE);}private function _save_forms($id,$data){$return=['success'=>false,'error'=>false,'message'=>''];do_action('_nextfeed_postforms_submit_data',$id,$data);$title=isset($data['basic']['name'])?$data['basic']['name']:'New Template - '.time();$type=isset($data['basic']['type'])?$data['basic']['type']:'';$categories=isset($data['basic']['categories'])?$data['basic']['categories']:'';$default=isset($data['basic']['default'])?$data['basic']['default']:'no';$post_type=Cpt::instance()->get_name();$keys=Cpt::instance()->get_key();if(empty(trim($title))){$return['error']=true;$return['message']=esc_html('Enter Template Name','next-feed');return $return;}$defaults=array('post_title'=>$title,'post_status'=>'publish','post_type'=>$post_type,);if($id!=''&&$id!=0){$post=get_post($id);if(property_exists($post,'ID')){$post_id=$post->ID;$update_post=array('ID'=>$post_id,'post_title'=>$title,);wp_update_post($update_post);$return['success']=true;$return['message']=esc_html('Template update successfully','next-feed');}else{$post_id=wp_insert_post($defaults);$return['success']=true;$return['message']=esc_html('Create new Template successfully','next-feed');}}else{$post_id=wp_insert_post($defaults);$return['success']=true;$return['message']=esc_html('Create new Template successfully','next-feed');}update_post_meta($post_id,$keys.'__type',$type);update_post_meta($post_id,$keys.'__categories',$categories);update_post_meta($post_id,$keys.'__data',$data);$defaultval=get_option($keys.'_'.$type.'-'.$categories.'__setdefault',true);if($default=='yes'){update_option($keys.'_'.$type.'-'.$categories.'__setdefault',$post_id);}else if($defaultval==$post_id){update_option($keys.'_'.$type.'-'.$categories.'__setdefault',0);}update_post_meta($post_id,'_wp_page_template','elementor_canvas');$return['data_id']=$post_id;$return['editor']=isset($data['_editor_mode'])?true:false;$return['editor_mode']=get_post_meta($post->ID,'_elementor_edit_mode',true);return $return;}private function _getforms(int $id){if(empty($id)){return;}$data=[];$post=get_post($id);if(property_exists($post,'ID')){$post_id=$post->ID;$keys=Cpt::instance()->get_key();$basic_type=get_post_meta($post_id,$keys.'__type',true);$basic_categories=get_post_meta($post_id,$keys.'__categories',true);$default=get_option($keys.'_'.$basic_type.'-'.$basic_categories.'__setdefault',true);$data['_basic_name']=$post->post_title;$data['_basic_type']=$basic_type;$data['_basic_categories']=$basic_categories;if($post_id==$default){$data['_basic_default']='yes';}else{$data['_basic_default']='no';}}return $data;}public static function instance(){if(!self::$instance){self::$instance=new self();}return self::$instance;}}